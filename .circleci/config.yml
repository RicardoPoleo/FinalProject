version: 2 # use CircleCI 2.0
jobs: # a collection of steps
  build: # runs not using Workflows must have a `build` job as entry point
    
    working_directory: ~/project

    docker: # run the steps with Docker
      - image: circleci/openjdk:8-jdk-stretch # ...with this image as the primary container; this is where all `steps` will run
         
      
        
    steps: # a collection of executable commands
      
      - checkout # check out source code to working directory
      
      - restore_cache:
          keys:
          - v1-dependencies-
          - v1-dependencies-

      - run:
          name: Install and start geckodriver
          command: |
            
            wget https://github.com/mozilla/geckodriver/releases/download/v0.20.1/geckodriver-v0.20.1-linux64.tar.gz &&
            tar -xvzf geckodriver-v0.20.1-linux64.tar.gz &&
            chmod +x geckodriver &&
            sudo mv geckodriver src/
        # https://github.com/circleci/circleci-images/issues/86
      
      - run:
          name: Install the latest firefox
          Path: project/
          command: |
            sudo sh -c "echo 'deb http://ftp.hr.debian.org/debian sid main' >> src/TestForm" &&
            sudo apt-get update &&
            sudo apt-get install -y xvfb
          background: true
          
        
        # firefox --version



      - restore_cache: # restore the saved cache after the first run or if `pom.xml` has changed
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: test-form-{{ checksum "pom.xml" }}      
      - run: mvn dependency:go-offline # gets the project dependencies
      
      - save_cache: # saves the project dependencies
          paths:
            - ~/.m2
          key: test-form-{{ checksum "pom.xml" }}
      
      - run: mvn package # run the actual tests
      
      - store_test_results: 
          path: src/TestForm 